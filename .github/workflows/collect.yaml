name: Collect
on:
  # ÊØèÂ§©ÂáåÊô®2ÁÇπÊâßË°åÔºàÈÅøÂºÄÈ´òÂ≥∞ÊúüÔºâ
  schedule:
    - cron: "0 2 * * *"
  # ‰øùÁïôÊâãÂä®Ëß¶ÂèëÂäüËÉΩ
  workflow_dispatch:
    inputs:
      force_clean:
        description: 'Force clean all cache'
        required: false
        default: 'false'
        type: boolean
      collection_mode:
        description: 'Collection mode'
        required: false
        default: 'auto'
        type: choice
        options:
        - 'auto'
        - 'aggressive'
        - 'conservative'

concurrency:
  group: ${{ github.repository }}
  cancel-in-progress: true

env:
  # time zone
  TZ: Asia/Shanghai

  # github access token
  GIST_PAT: ${{ secrets.GIST_PAT }}

  # github username and gist id, separated by '/'
  GIST_LINK: ${{ secrets.GIST_LINK }}

  # the url to the list of airports that you maintain yourself
  # each line include domain, coupon and invitation code, the domain must be included, and the latter two items are optional
  CUSTOMIZE_LINK: ${{ secrets.CUSTOMIZE_LINK }}

  # include special protocols, such as vless hysteria2 and hysteria
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

  # ‰ºòÂåñÁéØÂ¢ÉÂèòÈáèÔºåÁ°Æ‰øùËé∑ÂèñÊñ∞ËäÇÁÇπ
  WORKFLOW_MODE: "0"  # ÂÆåÊï¥ÁöÑÁà¨ÂèñÂíåËÅöÂêàÊ®°Âºè
  SKIP_ALIVE_CHECK: "false"  # Á°Æ‰øùÊ£ÄÊü•ËäÇÁÇπÂ≠òÊ¥ª
  SKIP_REMARK: "false"  # ‰∏çË∑≥ËøáÊ†áËÆ∞

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # ËÆæÁΩÆË∂ÖÊó∂Èò≤Ê≠¢Âç°Ê≠ª

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "x64"
          cache: "pip"
          cache-dependency-path: 'requirements.txt'

      - name: Install Dependencies
        run: |
          echo "=== Installing Dependencies ==="
          pip3 install --upgrade pip setuptools wheel
          pip3 install -r requirements.txt
          echo "‚úÖ Dependencies installed successfully"

      - name: Validate Environment Variables
        run: |
          echo "=== Environment Validation ==="
          
          # ÂøÖÈúÄÁöÑÁéØÂ¢ÉÂèòÈáèÊ£ÄÊü•
          ERROR_COUNT=0
          
          if [ -z "$GIST_PAT" ]; then
              echo "‚ùå Error: GIST_PAT cannot be empty"
              ERROR_COUNT=$((ERROR_COUNT + 1))
          else
              echo "‚úÖ GIST_PAT is configured"
          fi

          if [ -z "$GIST_LINK" ]; then
              echo "‚ùå Error: GIST_LINK cannot be empty"
              ERROR_COUNT=$((ERROR_COUNT + 1))
          else
              echo "‚úÖ GIST_LINK is set: $GIST_LINK"
              
              # È™åËØÅGIST_LINKÊ†ºÂºè
              LINK_PARTS=$(echo "$GIST_LINK" | awk -F'/' 'NF==2 && $1!="" && $2!=""')
              if [ -z "$LINK_PARTS" ]; then
                  echo "‚ùå Error: GIST_LINK format invalid, should be 'username/gist_id'"
                  ERROR_COUNT=$((ERROR_COUNT + 1))
              else
                  echo "‚úÖ GIST_LINK format is valid"
              fi
          fi

          # ÂèØÈÄâÁéØÂ¢ÉÂèòÈáèÊ£ÄÊü•
          if [ -n "$CUSTOMIZE_LINK" ]; then
              echo "‚úÖ CUSTOMIZE_LINK is configured"
          else
              echo "‚ÑπÔ∏è  CUSTOMIZE_LINK is not set (optional)"
          fi

          if [ -n "$ENABLE_SPECIAL_PROTOCOLS" ]; then
              echo "‚úÖ ENABLE_SPECIAL_PROTOCOLS: $ENABLE_SPECIAL_PROTOCOLS"
          else
              echo "‚ÑπÔ∏è  ENABLE_SPECIAL_PROTOCOLS is not set (optional)"
          fi
          
          if [ $ERROR_COUNT -gt 0 ]; then
              echo "‚ùå Validation failed with $ERROR_COUNT errors"
              exit 1
          fi
          
          echo "‚úÖ Environment validation passed"

      - name: Prepare Workspace and Clean Cache
        run: |
          echo "=== Workspace Preparation ==="
          
          # ÂàõÂª∫ÂøÖË¶ÅÁöÑÁõÆÂΩï
          mkdir -p data
          mkdir -p subconverter
          
          # Á°Æ‰øùÊâßË°åÊùÉÈôê
          chmod +x clash/clash-* || true
          chmod +x subconverter/subconverter-* || true
          
          # ÂÜ≥ÂÆöÊ∏ÖÁêÜÁ≠ñÁï•
          FORCE_CLEAN="${{ github.event.inputs.force_clean }}"
          CURRENT_DAY=$(date +%u)  # 1=Monday, 7=Sunday
          CURRENT_HOUR=$(date +%H)
          
          echo "üìÖ Current day: $CURRENT_DAY (1=Mon, 7=Sun)"
          echo "üïê Current hour: $CURRENT_HOUR"
          
          # Ê∏ÖÁêÜÁ≠ñÁï•
          if [ "$FORCE_CLEAN" = "true" ]; then
              echo "üßπ Force clean mode activated"
              CLEAN_MODE="force"
          elif [ "$CURRENT_DAY" = "1" ]; then
              echo "üßπ Weekly deep clean (Monday)"
              CLEAN_MODE="weekly"
          elif [ "$CURRENT_DAY" = "4" ]; then
              echo "üßπ Mid-week refresh (Thursday)"
              CLEAN_MODE="refresh"
          else
              echo "üîÑ Daily maintenance clean"
              CLEAN_MODE="daily"
          fi
          
          # ÊâßË°åÊ∏ÖÁêÜ
          case $CLEAN_MODE in
              "force"|"weekly")
                  echo "üóëÔ∏è  Performing deep clean..."
                  rm -f data/subscribes.txt data/domains.txt data/valid-domains.txt data/coupons.txt || true
                  rm -f subconverter/generate.ini subconverter/config.yaml || true
                  echo "‚úÖ Deep clean completed"
                  ;;
              "refresh")
                  echo "üîÑ Performing refresh clean..."
                  rm -f data/subscribes.txt data/valid-domains.txt || true
                  echo "‚úÖ Refresh clean completed"
                  ;;
              "daily")
                  echo "üßº Performing daily clean..."
                  rm -f data/subscribes.txt || true
                  echo "‚úÖ Daily clean completed"
                  ;;
          esac
          
          # ÊòæÁ§∫ÂΩìÂâçÁä∂ÊÄÅ
          echo "üìÅ Data directory contents:"
          ls -la data/ 2>/dev/null || echo "Data directory is empty"
          
          # ËæìÂá∫Ê∏ÖÁêÜÊ®°Âºè‰æõÂêéÁª≠Ê≠•È™§‰ΩøÁî®
          echo "CLEAN_MODE=$CLEAN_MODE" >> $GITHUB_ENV

      - name: Determine Collection Parameters
        run: |
          echo "=== Collection Parameters Setup ==="
          
          # Ëé∑ÂèñËæìÂÖ•ÂèÇÊï∞
          COLLECTION_MODE="${{ github.event.inputs.collection_mode }}"
          CURRENT_DAY=$(date +%u)
          CLEAN_MODE="${{ env.CLEAN_MODE }}"
          
          # ÈªòËÆ§ÂèÇÊï∞
          PAGES=5
          DELAY=4000
          FLOW=1
          LIFE=6
          THREADS=48
          EXTRA_ARGS=""
          
          # Ê†πÊçÆÊ®°ÂºèË∞ÉÊï¥ÂèÇÊï∞
          if [ "$COLLECTION_MODE" = "aggressive" ] || [ "$CLEAN_MODE" = "force" ] || [ "$CLEAN_MODE" = "weekly" ]; then
              echo "üöÄ Using aggressive collection mode"
              PAGES=10
              DELAY=6000
              FLOW=3
              LIFE=24
              THREADS=64
              EXTRA_ARGS="--easygoing"
          elif [ "$COLLECTION_MODE" = "conservative" ]; then
              echo "üêå Using conservative collection mode"
              PAGES=3
              DELAY=3000
              FLOW=0.5
              LIFE=3
              THREADS=32
          elif [ "$CURRENT_DAY" = "1" ]; then
              echo "üìÖ Monday - Using enhanced collection mode"
              PAGES=8
              DELAY=5000
              FLOW=2
              LIFE=12
              THREADS=56
              EXTRA_ARGS="--easygoing"
          elif [ "$CURRENT_DAY" = "4" ]; then
              echo "üìÖ Thursday - Using refresh collection mode"
              PAGES=6
              DELAY=4500
              FLOW=1.5
              LIFE=8
              THREADS=52
          else
              echo "üìÖ Regular day - Using standard collection mode"
          fi
          
          # ËæìÂá∫ÂèÇÊï∞‰æõÂêéÁª≠‰ΩøÁî®
          echo "COLLECT_PAGES=$PAGES" >> $GITHUB_ENV
          echo "COLLECT_DELAY=$DELAY" >> $GITHUB_ENV
          echo "COLLECT_FLOW=$FLOW" >> $GITHUB_ENV
          echo "COLLECT_LIFE=$LIFE" >> $GITHUB_ENV
          echo "COLLECT_THREADS=$THREADS" >> $GITHUB_ENV
          echo "COLLECT_EXTRA_ARGS=$EXTRA_ARGS" >> $GITHUB_ENV
          
          echo "üìä Collection parameters:"
          echo "  - Pages: $PAGES"
          echo "  - Delay: ${DELAY}ms"
          echo "  - Flow: ${FLOW}GB"
          echo "  - Life: ${LIFE}h"
          echo "  - Threads: $THREADS"
          echo "  - Extra args: $EXTRA_ARGS"

      - name: Collect Proxies
        run: |
          echo "=== Starting Proxy Collection ==="
          echo "üïê Start time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          
          # ÊûÑÂª∫ÂëΩ‰ª§
          CMD="python -u subscribe/collect.py"
          CMD="$CMD --all"
          CMD="$CMD --overwrite"
          CMD="$CMD --pages ${{ env.COLLECT_PAGES }}"
          CMD="$CMD --delay ${{ env.COLLECT_DELAY }}"
          CMD="$CMD --flow ${{ env.COLLECT_FLOW }}"
          CMD="$CMD --life ${{ env.COLLECT_LIFE }}"
          CMD="$CMD --num ${{ env.COLLECT_THREADS }}"
          
          # Ê∑ªÂä†È¢ùÂ§ñÂèÇÊï∞
          if [ -n "${{ env.COLLECT_EXTRA_ARGS }}" ]; then
              CMD="$CMD ${{ env.COLLECT_EXTRA_ARGS }}"
          fi
          
          echo "üöÄ Executing command: $CMD"
          echo ""
          
          # ÊâßË°åÊî∂ÈõÜ
          eval $CMD
          COLLECT_STATUS=$?
          
          echo ""
          echo "üìä Collection completed with status: $COLLECT_STATUS"
          echo "üïê End time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          
          if [ $COLLECT_STATUS -ne 0 ]; then
              echo "‚ùå Collection failed with exit code: $COLLECT_STATUS"
              exit $COLLECT_STATUS
          fi
          
          echo "‚úÖ Collection completed successfully"

      - name: Validate and Report Results
        run: |
          echo "=== Results Validation and Report ==="
          
          SUCCESS=true
          
          # Ê£ÄÊü•ËÆ¢ÈòÖÊñá‰ª∂
          if [ -f "data/subscribes.txt" ]; then
              SUB_COUNT=$(wc -l < data/subscribes.txt 2>/dev/null || echo "0")
              echo "‚úÖ Subscriptions found: $SUB_COUNT"
              
              if [ "$SUB_COUNT" -eq 0 ]; then
                  echo "‚ö†Ô∏è  Warning: No subscriptions in file"
                  SUCCESS=false
              elif [ "$SUB_COUNT" -lt 5 ]; then
                  echo "‚ö†Ô∏è  Warning: Very few subscriptions ($SUB_COUNT < 5)"
              fi
              
              # ÊòæÁ§∫ÂâçÂá†‰∏™ËÆ¢ÈòÖÔºàÈöêËóèÊïèÊÑü‰ø°ÊÅØÔºâ
              echo "üìã Sample subscriptions:"
              head -3 data/subscribes.txt | sed 's/token=[^&]*/token=****/g' || true
          else
              echo "‚ùå subscribes.txt not found"
              SUCCESS=false
          fi
          
          # Ê£ÄÊü•ÊúâÊïàÂüüÂêç
          if [ -f "data/valid-domains.txt" ]; then
              DOMAIN_COUNT=$(wc -l < data/valid-domains.txt 2>/dev/null || echo "0")
              echo "‚úÖ Valid domains found: $DOMAIN_COUNT"
              
              if [ "$DOMAIN_COUNT" -gt 0 ]; then
                  echo "üìã Sample domains:"
                  head -3 data/valid-domains.txt || true
              fi
          else
              echo "‚ÑπÔ∏è  valid-domains.txt not found (optional)"
          fi
          
          # Ê£ÄÊü•ÁîüÊàêÁöÑÈÖçÁΩÆÊñá‰ª∂
          echo "üìÅ Generated files:"
          find data/ -type f -name "*.txt" -o -name "*.yaml" -o -name "*.json" 2>/dev/null | \
              while read file; do
                  SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
                  echo "  - $file (${SIZE} bytes)"
              done
          
          # Ê£ÄÊü•ÁΩëÁªúËøûÊé•
          echo "üåê Network connectivity test:"
          if curl -s --max-time 10 https://www.google.com/generate_204 >/dev/null; then
              echo "‚úÖ Internet connection is working"
          else
              echo "‚ö†Ô∏è  Warning: Internet connection issues detected"
          fi
          
          # ÊúÄÁªàÁä∂ÊÄÅ
          if [ "$SUCCESS" = true ]; then
              echo "üéâ Validation passed - Collection was successful!"
          else
              echo "‚ùå Validation failed - Some issues detected"
              exit 1
          fi

      - name: System Information
        if: always()
        run: |
          echo "=== System Information ==="
          echo "üñ•Ô∏è  System info:"
          uname -a || true
          echo ""
          echo "üíæ Memory usage:"
          free -h || true
          echo ""
          echo "üíΩ Disk usage:"
          df -h / || true
          echo ""
          echo "üêç Python version:"
          python3 --version || true
          echo ""
          echo "üì¶ Installed packages:"
          pip3 list | grep -E "(requests|pyyaml|beautifulsoup)" || true

      - name: Cleanup and Summary
        if: always()
        run: |
          echo "=== Cleanup and Final Summary ==="
          
          # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
          echo "üßπ Cleaning temporary files..."
          rm -f subconverter/generate.ini || true
          rm -f clash/config.yaml || true
          find . -name "*.pyc" -delete 2>/dev/null || true
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "üìä Final statistics:"
          echo "  - Workflow duration: $((SECONDS / 60)) minutes $((SECONDS % 60)) seconds"
          echo "  - Completion time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "  - Next scheduled run: $(date -d 'tomorrow 2:00' '+%Y-%m-%d %H:%M:%S %Z' 2>/dev/null || echo 'Tomorrow at 02:00')"
          
          # GitHub API ‰ΩøÁî®ÊÉÖÂÜµ
          if [ -n "$GIST_PAT" ]; then
              echo "üîó GitHub API rate limit status:"
              curl -s -H "Authorization: token $GIST_PAT" https://api.github.com/rate_limit | \
                  jq -r '.rate | "Used: \(.used)/\(.limit), Reset: \(.reset | strftime("%Y-%m-%d %H:%M:%S"))"' 2>/dev/null || \
                  echo "Rate limit check failed"
          fi
          
          echo "‚úÖ Workflow completed successfully!"

      - name: Final Timestamp
        run: |
          echo "=== Final Timestamp ==="
          echo "üèÅ Workflow completed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "‚è∞ Total execution time: $((SECONDS / 60))m $((SECONDS % 60))s"
          echo "üîÑ Status: SUCCESS"
