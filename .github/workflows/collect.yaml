name: Collect
on:
  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆé¿å¼€é«˜å³°æœŸï¼‰
  schedule:
    - cron: "0 2 * * *"
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘åŠŸèƒ½
  workflow_dispatch:
    inputs:
      force_clean:
        description: 'Force clean all cache'
        required: false
        default: 'false'
        type: boolean
      collection_mode:
        description: 'Collection mode'
        required: false
        default: 'original'
        type: choice
        options:
        - 'auto'
        - 'aggressive'
        - 'conservative'
        - 'original'

concurrency:
  group: ${{ github.repository }}
  cancel-in-progress: true

env:
  # time zone
  TZ: Asia/Shanghai

  # github access token
  GIST_PAT: ${{ secrets.GIST_PAT }}

  # github username and gist id, separated by '/'
  GIST_LINK: ${{ secrets.GIST_LINK }}

  # the url to the list of airports that you maintain yourself
  # each line include domain, coupon and invitation code, the domain must be included, and the latter two items are optional
  CUSTOMIZE_LINK: ${{ secrets.CUSTOMIZE_LINK }}

  # include special protocols, such as vless hysteria2 and hysteria
  ENABLE_SPECIAL_PROTOCOLS: ${{ vars.ENABLE_SPECIAL_PROTOCOLS }}

  # ä¼˜åŒ–ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿è·å–æ–°èŠ‚ç‚¹
  WORKFLOW_MODE: "0"  # å®Œæ•´çš„çˆ¬å–å’Œèšåˆæ¨¡å¼
  SKIP_ALIVE_CHECK: "false"  # ç¡®ä¿æ£€æŸ¥èŠ‚ç‚¹å­˜æ´»
  SKIP_REMARK: "false"  # ä¸è·³è¿‡æ ‡è®°

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # è®¾ç½®è¶…æ—¶é˜²æ­¢å¡æ­»

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "x64"
          cache: "pip"
          cache-dependency-path: 'requirements.txt'

      - name: Install Dependencies
        run: |
          echo "=== Installing Dependencies ==="
          pip3 install --upgrade pip setuptools wheel
          pip3 install -r requirements.txt
          echo "âœ… Dependencies installed successfully"

      - name: Validate Environment Variables
        run: |
          echo "=== Environment Validation ==="
          
          # å¿…éœ€çš„ç¯å¢ƒå˜é‡æ£€æŸ¥
          ERROR_COUNT=0
          
          if [ -z "$GIST_PAT" ]; then
              echo "âŒ Error: GIST_PAT cannot be empty"
              ERROR_COUNT=$((ERROR_COUNT + 1))
          else
              echo "âœ… GIST_PAT is configured"
          fi

          if [ -z "$GIST_LINK" ]; then
              echo "âŒ Error: GIST_LINK cannot be empty"
              ERROR_COUNT=$((ERROR_COUNT + 1))
          else
              echo "âœ… GIST_LINK is set: $GIST_LINK"
              
              # éªŒè¯GIST_LINKæ ¼å¼
              LINK_PARTS=$(echo "$GIST_LINK" | awk -F'/' 'NF==2 && $1!="" && $2!=""')
              if [ -z "$LINK_PARTS" ]; then
                  echo "âŒ Error: GIST_LINK format invalid, should be 'username/gist_id'"
                  ERROR_COUNT=$((ERROR_COUNT + 1))
              else
                  echo "âœ… GIST_LINK format is valid"
              fi
          fi

          # å¯é€‰ç¯å¢ƒå˜é‡æ£€æŸ¥
          if [ -n "$CUSTOMIZE_LINK" ]; then
              echo "âœ… CUSTOMIZE_LINK is configured"
          else
              echo "â„¹ï¸  CUSTOMIZE_LINK is not set (optional)"
          fi

          if [ -n "$ENABLE_SPECIAL_PROTOCOLS" ]; then
              echo "âœ… ENABLE_SPECIAL_PROTOCOLS: $ENABLE_SPECIAL_PROTOCOLS"
          else
              echo "â„¹ï¸  ENABLE_SPECIAL_PROTOCOLS is not set (optional)"
          fi
          
          if [ $ERROR_COUNT -gt 0 ]; then
              echo "âŒ Validation failed with $ERROR_COUNT errors"
              exit 1
          fi
          
          echo "âœ… Environment validation passed"

      - name: Prepare Workspace and Clean Cache
        run: |
          echo "=== Workspace Preparation ==="
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p data
          mkdir -p subconverter
          
          # ç¡®ä¿æ‰§è¡Œæƒé™
          chmod +x clash/clash-* || true
          chmod +x subconverter/subconverter-* || true
          
          # å†³å®šæ¸…ç†ç­–ç•¥
          FORCE_CLEAN="${{ github.event.inputs.force_clean }}"
          CURRENT_DAY=$(date +%u)  # 1=Monday, 7=Sunday
          CURRENT_HOUR=$(date +%H)
          
          echo "ğŸ“… Current day: $CURRENT_DAY (1=Mon, 7=Sun)"
          echo "ğŸ• Current hour: $CURRENT_HOUR"
          
          # æ¸…ç†ç­–ç•¥
          if [ "$FORCE_CLEAN" = "true" ]; then
              echo "ğŸ§¹ Force clean mode activated"
              CLEAN_MODE="force"
          elif [ "$CURRENT_DAY" = "1" ]; then
              echo "ğŸ§¹ Weekly deep clean (Monday)"
              CLEAN_MODE="weekly"
          elif [ "$CURRENT_DAY" = "4" ]; then
              echo "ğŸ§¹ Mid-week refresh (Thursday)"
              CLEAN_MODE="refresh"
          else
              echo "ğŸ”„ Daily maintenance clean"
              CLEAN_MODE="daily"
          fi
          
          # æ‰§è¡Œæ¸…ç†
          case $CLEAN_MODE in
              "force"|"weekly")
                  echo "ğŸ—‘ï¸  Performing deep clean..."
                  rm -f data/subscribes.txt data/domains.txt data/valid-domains.txt data/coupons.txt || true
                  rm -f subconverter/generate.ini subconverter/config.yaml || true
                  echo "âœ… Deep clean completed"
                  ;;
              "refresh")
                  echo "ğŸ”„ Performing refresh clean..."
                  rm -f data/subscribes.txt data/valid-domains.txt || true
                  echo "âœ… Refresh clean completed"
                  ;;
              "daily")
                  echo "ğŸ§¼ Performing daily clean..."
                  rm -f data/subscribes.txt || true
                  echo "âœ… Daily clean completed"
                  ;;
          esac
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "ğŸ“ Data directory contents:"
          ls -la data/ 2>/dev/null || echo "Data directory is empty"
          
          # è¾“å‡ºæ¸…ç†æ¨¡å¼ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CLEAN_MODE=$CLEAN_MODE" >> $GITHUB_ENV

      - name: Determine Collection Parameters
        run: |
          echo "=== Collection Parameters Setup ==="
          
          # è·å–è¾“å…¥å‚æ•°
          COLLECTION_MODE="${{ github.event.inputs.collection_mode }}"
          CURRENT_DAY=$(date +%u)
          CLEAN_MODE="${{ env.CLEAN_MODE }}"
          
          # é»˜è®¤å‚æ•°ï¼ˆæ›´å®½æ¾ï¼Œæ¥è¿‘åŸå§‹æ•ˆæœï¼‰
          PAGES=8
          DELAY=5000
          FLOW=0
          LIFE=0
          THREADS=64
          EXTRA_ARGS="--skip"
          
          # æ ¹æ®æ¨¡å¼è°ƒæ•´å‚æ•°
          if [ "$COLLECTION_MODE" = "original" ]; then
              echo "ğŸ”„ Using original collection mode (maximum compatibility)"
              PAGES=""  # ä¸é™åˆ¶é¡µé¢æ•°
              DELAY=5000
              FLOW=0
              LIFE=0
              THREADS=64
              EXTRA_ARGS="--skip"
          elif [ "$COLLECTION_MODE" = "aggressive" ] || [ "$CLEAN_MODE" = "force" ] || [ "$CLEAN_MODE" = "weekly" ]; then
              echo "ğŸš€ Using aggressive collection mode"
              PAGES=15
              DELAY=6000
              FLOW=0
              LIFE=0
              THREADS=64
              EXTRA_ARGS="--skip --easygoing"
          elif [ "$COLLECTION_MODE" = "conservative" ]; then
              echo "ğŸŒ Using conservative collection mode"
              PAGES=5
              DELAY=4000
              FLOW=1
              LIFE=6
              THREADS=48
              EXTRA_ARGS=""
          elif [ "$CURRENT_DAY" = "1" ]; then
              echo "ğŸ“… Monday - Using enhanced collection mode"
              PAGES=12
              DELAY=5000
              FLOW=0
              LIFE=0
              THREADS=64
              EXTRA_ARGS="--skip --easygoing"
          elif [ "$CURRENT_DAY" = "4" ]; then
              echo "ğŸ“… Thursday - Using quality check mode"
              PAGES=8
              DELAY=4000
              FLOW=0.5
              LIFE=3
              THREADS=56
              EXTRA_ARGS=""
          else
              echo "ğŸ“… Regular day - Using balanced collection mode"
          fi
          
          # è¾“å‡ºå‚æ•°ä¾›åç»­ä½¿ç”¨
          echo "COLLECT_PAGES=$PAGES" >> $GITHUB_ENV
          echo "COLLECT_DELAY=$DELAY" >> $GITHUB_ENV
          echo "COLLECT_FLOW=$FLOW" >> $GITHUB_ENV
          echo "COLLECT_LIFE=$LIFE" >> $GITHUB_ENV
          echo "COLLECT_THREADS=$THREADS" >> $GITHUB_ENV
          echo "COLLECT_EXTRA_ARGS=$EXTRA_ARGS" >> $GITHUB_ENV
          
          echo "ğŸ“Š Collection parameters:"
          echo "  - Pages: $PAGES"
          echo "  - Delay: ${DELAY}ms"
          echo "  - Flow: ${FLOW}GB"
          echo "  - Life: ${LIFE}h"
          echo "  - Threads: $THREADS"
          echo "  - Extra args: $EXTRA_ARGS"

      - name: Collect Proxies
        run: |
          echo "=== Starting Proxy Collection ==="
          echo "ğŸ• Start time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          
          # æ„å»ºå‘½ä»¤
          CMD="python -u subscribe/collect.py"
          CMD="$CMD --all"
          CMD="$CMD --overwrite"
          
          # åªåœ¨æœ‰å€¼æ—¶æ·»åŠ å‚æ•°
          if [ -n "${{ env.COLLECT_PAGES }}" ]; then
              CMD="$CMD --pages ${{ env.COLLECT_PAGES }}"
          fi
          
          CMD="$CMD --delay ${{ env.COLLECT_DELAY }}"
          
          # åªåœ¨å¤§äº0æ—¶æ·»åŠ æµé‡å’Œæ—¶é—´é™åˆ¶
          if [ "${{ env.COLLECT_FLOW }}" != "0" ]; then
              CMD="$CMD --flow ${{ env.COLLECT_FLOW }}"
          fi
          
          if [ "${{ env.COLLECT_LIFE }}" != "0" ]; then
              CMD="$CMD --life ${{ env.COLLECT_LIFE }}"
          fi
          
          CMD="$CMD --num ${{ env.COLLECT_THREADS }}"
          
          # æ·»åŠ é¢å¤–å‚æ•°
          if [ -n "${{ env.COLLECT_EXTRA_ARGS }}" ]; then
              CMD="$CMD ${{ env.COLLECT_EXTRA_ARGS }}"
          fi
          
          echo "ğŸš€ Executing command: $CMD"
          echo ""
          
          # æ‰§è¡Œæ”¶é›†
          eval $CMD
          COLLECT_STATUS=$?
          
          echo ""
          echo "ğŸ“Š Collection completed with status: $COLLECT_STATUS"
          echo "ğŸ• End time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          
          if [ $COLLECT_STATUS -ne 0 ]; then
              echo "âŒ Collection failed with exit code: $COLLECT_STATUS"
              exit $COLLECT_STATUS
          fi
          
          echo "âœ… Collection completed successfully"

      - name: Validate and Report Results
        run: |
          echo "=== Results Validation and Report ==="
          
          SUCCESS=true
          
          # æ£€æŸ¥è®¢é˜…æ–‡ä»¶
          if [ -f "data/subscribes.txt" ]; then
              SUB_COUNT=$(wc -l < data/subscribes.txt 2>/dev/null || echo "0")
              echo "âœ… Subscriptions found: $SUB_COUNT"
              
              if [ "$SUB_COUNT" -eq 0 ]; then
                  echo "âš ï¸  Warning: No subscriptions in file"
                  SUCCESS=false
              elif [ "$SUB_COUNT" -lt 5 ]; then
                  echo "âš ï¸  Warning: Very few subscriptions ($SUB_COUNT < 5)"
              fi
              
              # æ˜¾ç¤ºå‰å‡ ä¸ªè®¢é˜…ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
              echo "ğŸ“‹ Sample subscriptions:"
              head -3 data/subscribes.txt | sed 's/token=[^&]*/token=****/g' || true
          else
              echo "âŒ subscribes.txt not found"
              SUCCESS=false
          fi
          
          # æ£€æŸ¥æœ‰æ•ˆåŸŸå
          if [ -f "data/valid-domains.txt" ]; then
              DOMAIN_COUNT=$(wc -l < data/valid-domains.txt 2>/dev/null || echo "0")
              echo "âœ… Valid domains found: $DOMAIN_COUNT"
              
              if [ "$DOMAIN_COUNT" -gt 0 ]; then
                  echo "ğŸ“‹ Sample domains:"
                  head -3 data/valid-domains.txt || true
              fi
          else
              echo "â„¹ï¸  valid-domains.txt not found (optional)"
          fi
          
          # æ£€æŸ¥ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
          echo "ğŸ“ Generated files:"
          find data/ -type f -name "*.txt" -o -name "*.yaml" -o -name "*.json" 2>/dev/null | \
              while read file; do
                  SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
                  echo "  - $file (${SIZE} bytes)"
              done
          
          # æ£€æŸ¥ç½‘ç»œè¿æ¥
          echo "ğŸŒ Network connectivity test:"
          if curl -s --max-time 10 https://www.google.com/generate_204 >/dev/null; then
              echo "âœ… Internet connection is working"
          else
              echo "âš ï¸  Warning: Internet connection issues detected"
          fi
          
          # æœ€ç»ˆçŠ¶æ€
          if [ "$SUCCESS" = true ]; then
              echo "ğŸ‰ Validation passed - Collection was successful!"
          else
              echo "âŒ Validation failed - Some issues detected"
              exit 1
          fi

      - name: System Information
        if: always()
        run: |
          echo "=== System Information ==="
          echo "ğŸ–¥ï¸  System info:"
          uname -a || true
          echo ""
          echo "ğŸ’¾ Memory usage:"
          free -h || true
          echo ""
          echo "ğŸ’½ Disk usage:"
          df -h / || true
          echo ""
          echo "ğŸ Python version:"
          python3 --version || true
          echo ""
          echo "ğŸ“¦ Installed packages:"
          pip3 list | grep -E "(requests|pyyaml|beautifulsoup)" || true

      - name: Cleanup and Summary
        if: always()
        run: |
          echo "=== Cleanup and Final Summary ==="
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          echo "ğŸ§¹ Cleaning temporary files..."
          rm -f subconverter/generate.ini || true
          rm -f clash/config.yaml || true
          find . -name "*.pyc" -delete 2>/dev/null || true
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "ğŸ“Š Final statistics:"
          echo "  - Workflow duration: $((SECONDS / 60)) minutes $((SECONDS % 60)) seconds"
          echo "  - Completion time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "  - Next scheduled run: $(date -d 'tomorrow 2:00' '+%Y-%m-%d %H:%M:%S %Z' 2>/dev/null || echo 'Tomorrow at 02:00')"
          
          # GitHub API ä½¿ç”¨æƒ…å†µ
          if [ -n "$GIST_PAT" ]; then
              echo "ğŸ”— GitHub API rate limit status:"
              curl -s -H "Authorization: token $GIST_PAT" https://api.github.com/rate_limit | \
                  jq -r '.rate | "Used: \(.used)/\(.limit), Reset: \(.reset | strftime("%Y-%m-%d %H:%M:%S"))"' 2>/dev/null || \
                  echo "Rate limit check failed"
          fi
          
          echo "âœ… Workflow completed successfully!"

      - name: Final Timestamp
        run: |
          echo "=== Final Timestamp ==="
          echo "ğŸ Workflow completed at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "â° Total execution time: $((SECONDS / 60))m $((SECONDS % 60))s"
          echo "ğŸ”„ Status: SUCCESS"
